<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Video to Transcript</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center px-4">

  <div class="bg-white shadow-xl rounded-2xl p-8 max-w-2xl w-full" id="form-container">
    <h1 class="text-2xl font-bold mb-4 text-center text-gray-800">🎬 Video to Transcript</h1>

    <form action="/" method="post" enctype="multipart/form-data" class="space-y-4" onsubmit="showLoader()">
      <div>
        <label for="video" class="block text-sm font-medium text-gray-700">Upload Video File</label>
        <input type="file" name="video" accept="video/*" required
               class="mt-1 block w-full text-sm text-gray-700 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 p-2">
      </div>
      <div>
        <label for="language" class="block text-sm font-medium text-gray-700">Choose Language (optional)</label>
        <select name="language" id="language"
                class="mt-1 block w-full text-sm text-gray-700 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 p-2">
          <option value="">Auto Detect</option>
          <option value="en">English</option>
          <option value="es">Spanish</option>
          <option value="fr">French</option>
          <option value="hi">Hindi</option>
          <option value="ur">Urdu</option>
          <option value="ar">Arabic</option>
          <option value="zh">Chinese</option>
          <option value="de">German</option>
          <option value="ja">Japanese</option>
        </select>
      </div>

      <div class="text-center">
        <button type="submit"
                class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-6 rounded-lg shadow-md">
          Transcribe
        </button>
      </div>
    </form>
{% if title %}
<div class="mt-6 text-center">
  <h2 class="text-2xl font-extrabold text-indigo-700">🏷️ Title: {{ title }}</h2>
</div>
{% endif %}

    {% if transcript %}
    <div class="mt-8">
      {% if audio_url %}
      <div class="mt-4">
        <h2 class="text-lg font-semibold">🎧 Extracted Audio:</h2>
        <audio controls class="mt-2 w-full">
          <source src="{{ audio_url }}" type="audio/wav">
          Your browser does not support the audio element.
        </audio>
        <a href="{{ audio_url }}" download class="mt-3 inline-block bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">
          ⬇️ Download Audio
        </a>
      </div>
      {% endif %}

      {% if detected_language %}
      <p class="text-sm text-gray-700 mt-4">
        🌍 <span class="font-medium">Detected Language:</span>
        <span class="ml-1">{{ detected_language }}</span>
      </p>
      {% endif %}

      <h2 class="text-lg font-semibold text-gray-800 mb-2">📝 Transcription Result:</h2>
      <textarea id="transcriptText" rows="12" readonly
                class="w-full p-4 border border-gray-300 rounded-lg text-sm text-gray-800 bg-gray-50 focus:outline-none resize-y">{{ transcript }}</textarea>
      <button onclick="copyToClipboard('transcriptText')" class="mt-2 bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700 transition">
        📋 Copy Transcript
      </button>
    </div>
    {% endif %}

    {% if summary %}
    <div class="mt-8 p-4 bg-green-50 rounded-lg shadow" id="summarySection">
      <h2 class="text-xl font-bold mb-2 text-green-800">📄 Summary</h2>
      <p class="text-gray-900" id="summaryText">{{ summary }}</p>
      <button onclick="resummarize()" class="mt-4 bg-indigo-500 text-white px-4 py-2 rounded hover:bg-indigo-600 transition">
        🔁 Re-summarize
      </button>
    </div>
    {% endif %}

    {% if key_points %}
    <div class="mt-6 p-4 bg-yellow-50 rounded-lg shadow" id="keyPointsSection">
      <h2 class="text-xl font-bold mb-2 text-yellow-800">📌 Key Points</h2>
      <ul id="keyPointsList" class="list-disc list-inside text-gray-800">
        {% for point in key_points %}
        <li>{{ point }}</li>
        {% endfor %}
      </ul>
    </div>
    {% endif %}

    {% if summary or key_points or transcript %}
    <div class="mt-6 space-y-2">
      <label for="translateLang" class="block mb-1 font-medium">🌐 Translate to:</label>
      <select id="translateLang" class="p-2 border rounded w-full max-w-xs">
        <option value="es">Spanish</option>
        <option value="fr">French</option>
        <option value="de">German</option>
        <option value="hi">Hindi</option>
        <option value="ur">Urdu</option>
        <option value="zh">Chinese</option>
        <option value="ar">Arabic</option>
        <option value="it">Italian</option>
        <option value="ru">Russian</option>
      </select>

      <div class="space-x-2 mt-2">
        <button onclick="translateField('summaryText')" class="px-3 py-1 bg-purple-600 text-white rounded hover:bg-purple-700">
          📄 Translate Summary
        </button>
        <button onclick="translateField('transcriptText')" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700">
          🎧 Translate Transcript
        </button>
        <button onclick="translateKeyPoints()" class="px-3 py-1 bg-yellow-600 text-white rounded hover:bg-yellow-700">
          📌 Translate Key Points
        </button>
      </div>
    </div>
    {% endif %}
  </div>

  <!-- Loader (hidden by default) -->
  <div class="hidden flex-col items-center" id="loader">
    <svg class="animate-spin h-10 w-10 text-indigo-600 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8H4z"></path>
    </svg>
    <p class="text-gray-700 text-lg">Transcribing video... please wait</p>
  </div>

  <script>
    let originalSummary = "";
    let originalTranscript = "";
    let originalKeyPoints = [];

    window.onload = () => {
      const summaryEl = document.getElementById("summaryText");
      if (summaryEl) originalSummary = summaryEl.textContent;

      const transcriptEl = document.getElementById("transcriptText");
      if (transcriptEl) originalTranscript = transcriptEl.value;

      const keyPointsEls = document.querySelectorAll("#keyPointsList li");
      if (keyPointsEls.length > 0) {
        originalKeyPoints = Array.from(keyPointsEls).map(li => li.textContent);
      }
    };

    function showLoader() {
      document.getElementById("form-container").style.display = "none";
      document.getElementById("loader").style.display = "flex";
    }

    function copyToClipboard(elementId) {
      const textArea = document.getElementById(elementId);
      textArea.select();
      document.execCommand("copy");
      alert("✅ Transcript copied to clipboard!");
    }

    function resummarize() {
      const summaryText = originalSummary;

      fetch("/resummarize", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: "summary=" + encodeURIComponent(summaryText)
      })
      .then(res => res.json())
      .then(data => {
        if (data.error) {
          alert("❌ " + data.error);
          return;
        }

        document.getElementById("summaryText").textContent = data.summary;
        originalSummary = data.summary;

        const keyPointsList = document.getElementById("keyPointsList");
        keyPointsList.innerHTML = "";
        originalKeyPoints = data.key_points;

        data.key_points.forEach(point => {
          const li = document.createElement("li");
          li.textContent = point;
          keyPointsList.appendChild(li);
        });
      })
      .catch(error => {
        alert("⚠️ Error re-summarizing: " + error);
      });
    }

    function translateField(elementId) {
      let text = "";
      if (elementId === "summaryText") {
        text = originalSummary;
      } else if (elementId === "transcriptText") {
        text = originalTranscript;
      }

      const lang = document.getElementById("translateLang").value;

      fetch("/translate", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: `text=${encodeURIComponent(text)}&target_lang=${lang}`
      })
      .then(res => res.json())
      .then(data => {
        if (data.translated) {
          const el = document.getElementById(elementId);
          if (el.tagName === "TEXTAREA") {
            el.value = data.translated;
          } else {
            el.textContent = data.translated;
          }
        } else {
          alert("❌ Translation failed");
        }
      })
      .catch(err => {
        alert("⚠️ Error translating: " + err.message);
      });
    }

    function translateKeyPoints() {
      const text = originalKeyPoints.join("\n");
      const lang = document.getElementById("translateLang").value;

      fetch("/translate", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: `text=${encodeURIComponent(text)}&target_lang=${lang}`
      })
      .then(res => res.json())
      .then(data => {
        if (data.translated) {
          const translatedList = data.translated.split("\n").filter(p => p.trim());
          const ul = document.getElementById("keyPointsList");
          ul.innerHTML = "";
          translatedList.forEach(point => {
            const li = document.createElement("li");
            li.textContent = point.trim();
            ul.appendChild(li);
          });
        } else {
          alert("❌ Translation failed");
        }
      })
      .catch(err => {
        alert("⚠️ Error translating: " + err.message);
      });
    }
  </script>

</body>
</html>
